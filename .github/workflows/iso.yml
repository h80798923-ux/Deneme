name: Build TrixieOS (TinyCore)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          wget xorriso squashfs-tools grub-pc-bin \
          syslinux-utils cpio

    - name: Download TinyCore
      run: |
        mkdir work
        cd work
        wget http://tinycorelinux.net/14.x/x86/release/Core-current.iso

    - name: Extract ISO
      run: |
        cd work
        mkdir iso rootfs
        bsdtar -xf Core-current.iso -C iso

    - name: Prepare RootFS
      run: |
        cd work
        mkdir -p rootfs/{bin,sbin,etc,proc,sys,usr/bin,root,tmp}
        cp -a iso/boot/core.gz .
        cd rootfs

        # BusyBox
        wget https://busybox.net/downloads/binaries/1.36.1-i686-uclibc/busybox
        chmod +x busybox
        ./busybox --install -s bin

    - name: Install GUI (Openbox)
      run: |
        cd work/rootfs
        mkdir -p usr/local/bin etc/X11/openbox

        cat > usr/local/bin/startx << 'EOF'
        #!/bin/sh
        exec openbox-session
        EOF
        chmod +x usr/local/bin/startx

        echo "openbox-session" > etc/X11/openbox/autostart

    - name: Virtual Keyboard & Mouse
      run: |
        cd work/rootfs
        mkdir -p usr/local/bin
        cat > usr/local/bin/virtual-input << 'EOF'
        #!/bin/sh
        echo "Virtual input started"
        EOF
        chmod +x usr/local/bin/virtual-input

    - name: PRA Package Manager (Custom)
      run: |
        cd work/rootfs
        mkdir -p usr/bin
        cat > usr/bin/pra << 'EOF'
        #!/bin/sh
        echo "PRA Package Manager"
        echo "Komutlar:"
        echo "  pra install <pkg>"
        echo "  pra list"
        EOF
        chmod +x usr/bin/pra

    - name: Init Script
      run: |
        cd work/rootfs
        cat > init << 'EOF'
        #!/bin/sh
        mount -t proc proc /proc
        mount -t sysfs sysfs /sys
        exec /bin/sh
        EOF
        chmod +x init

    - name: Create SquashFS
      run: |
        cd work
        mksquashfs rootfs trixieos.sqfs -comp xz

    - name: Build ISO
      run: |
        cd work
        mkdir iso_new
        cp -a iso/* iso_new/
        cp trixieos.sqfs iso_new/boot/

        xorriso -as mkisofs \
          -l -J -R \
          -V "TrixieOS" \
          -no-emul-boot \
          -boot-load-size 4 \
          -boot-info-table \
          -o TrixieOS.iso iso_new

    - uses: actions/upload-artifact@v4
      with:
        name: TrixieOS
        path: work/TrixieOS.iso
